# üî¥ –ü–†–û–ë–õ–ï–ú–´ –ù–ï–°–¢–ê–ë–ò–õ–¨–ù–û–°–¢–ò –ë–î –ò –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò

**–î–∞—Ç–∞:** 10 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** üîç –ù–ê–ô–î–ï–ù–û 5 –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –ü–†–û–ë–õ–ï–ú

---

## üêõ –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

### 1. ‚ùå –ù–ï–¢ –ù–ê–°–¢–†–û–ï–ö CONNECTION POOL

**–§–∞–π–ª:** `src/lib/prisma.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
export const prisma = new PrismaClient({
  log: ['error', 'warn'],
  // ‚ùå –ù–ï–¢ –Ω–∞—Å—Ç—Ä–æ–µ–∫ connection pool!
});
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é Prisma —Å–æ–∑–¥–∞–µ—Ç –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–π pool (10 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π)
- –ü—Ä–∏ 12+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è
- –ü–æ—è–≤–ª—è–µ—Ç—Å—è –æ—à–∏–±–∫–∞ "Too many connections"
- –ó–∞–ø—Ä–æ—Å—ã –∑–∞–≤–∏—Å–∞—é—Ç –∏–ª–∏ –ø–∞–¥–∞—é—Ç —Å timeout

---

### 2. ‚ùå –ù–ï–¢ –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø –û–®–ò–ë–û–ö –¢–û–ö–ï–ù–û–í

**–§–∞–π–ª:** `src/lib/auth.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
export function verifyToken(token: string): JWTPayload | null {
  try {
    const decoded = jwt.verify(token, getJwtSecret()) as JWTPayload;
    return decoded;
  } catch (error) {
    return null;  // ‚ùå –ü—Ä–æ—Å—Ç–æ null, –±–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è!
  }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ù–µ –ø–æ–Ω—è—Ç–Ω–æ –ü–û–ß–ï–ú–£ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω
- –ú–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å—Ç—ë–∫, –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω, –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–µ–∫—Ä–µ—Ç
- –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ –æ—Ç–ª–∞–¥–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É

---

### 3. ‚ùå –¢–û–ö–ï–ù–´ –ò–°–¢–ï–ö–ê–Æ–¢ –ë–ï–ó –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø

**–§–∞–π–ª:** `src/app/api/auth/login/route.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
const token = jwt.sign(
  { userId, login, role, city },
  getJwtSecret(),
  { expiresIn: '7d' }  // ‚ùå –ß–µ—Ä–µ–∑ 7 –¥–Ω–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã–∫–∏–Ω–µ—Ç!
);
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ß–µ—Ä–µ–∑ 7 –¥–Ω–µ–π —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫–∞–µ—Ç
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã–∫–∏–¥—ã–≤–∞–µ—Ç –∏–∑ —Å–∏—Å—Ç–µ–º—ã –±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- –ù—É–∂–Ω–æ –∑–∞–Ω–æ–≤–æ –ª–æ–≥–∏–Ω–∏—Ç—å—Å—è
- –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞

---

### 4. ‚ùå MIDDLEWARE –ù–ï –ü–†–û–í–ï–†–Ø–ï–¢ –í–ê–õ–ò–î–ù–û–°–¢–¨ –¢–û–ö–ï–ù–ê

**–§–∞–π–ª:** `src/middleware.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
if (pathname.startsWith('/dashboard')) {
  const token = request.cookies.get('token')?.value;
  
  if (!token) {
    return NextResponse.redirect(loginUrl);
  }
  
  // ‚ùå –ü—Ä–æ—Å—Ç–æ –ø—É—Å–∫–∞–µ—Ç –¥–∞–ª—å—à–µ, –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—è –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å!
  return NextResponse.next();
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- Middleware –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –¥–∞–∂–µ –∏—Å—Ç–µ–∫—à–∏–µ —Ç–æ–∫–µ–Ω—ã
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø–∞–¥–∞–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É, –Ω–æ –≤—Å–µ API –∑–∞–ø—Ä–æ—Å—ã –ø–∞–¥–∞—é—Ç —Å 401
- –ü–æ–ª—É—á–∞–µ—Ç—Å—è "–º–∏–≥–∞—é—â–∏–π" —ç–∫—Ä–∞–Ω - –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å, –Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### 5. ‚ùå –ù–ï–¢ GRACEFUL SHUTDOWN

**–§–∞–π–ª:** `src/lib/prisma.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ SIGTERM/SIGINT
- –ü—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –û—Å—Ç–∞—é—Ç—Å—è "zombie" —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤ –ë–î
- –ü—Ä–∏ –Ω–æ–≤–æ–º –∑–∞–ø—É—Å–∫–µ –æ–Ω–∏ –∑–∞–Ω–∏–º–∞—é—Ç –º–µ—Å—Ç–∞ –≤ pool

---

## üéØ –ö–ê–ö –≠–¢–û –ü–†–û–Ø–í–õ–Ø–ï–¢–°–Ø:

### –°–∏–º–ø—Ç–æ–º 1: "–ü—Ä–∏ –ª–æ–≥–∏–Ω–µ —á–∞—Å—Ç–æ –æ—à–∏–±–∫–∞"
**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–æ–±–ª–µ–º–∞ #1 (connection pool) + –ü—Ä–æ–±–ª–µ–º–∞ #5 (zombie connections)
- Pool –∑–∞–ø–æ–ª–Ω–µ–Ω
- –ù–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω–æ
- –û—à–∏–±–∫–∞ "Connection timeout"
- –ß–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è - —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°–∏–º–ø—Ç–æ–º 2: "–õ—é–¥–µ–π –≤—ã–∫–∏–¥—ã–≤–∞–µ—Ç –∏–∑ —Å–∏—Å—Ç–µ–º—ã"
**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–æ–±–ª–µ–º–∞ #3 (–∏—Å—Ç–µ—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞) + –ü—Ä–æ–±–ª–µ–º–∞ #4 (middleware)
- –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫–∞–µ—Ç
- Middleware –Ω–µ –∑–∞–º–µ—á–∞–µ—Ç (–µ—Å—Ç—å cookie)
- API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –æ—à–∏–±–∫—É

### –°–∏–º–ø—Ç–æ–º 3: "–¢–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç–æ –Ω–µ—Ç"
**–ü—Ä–∏—á–∏–Ω–∞:** –í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã –≤–º–µ—Å—Ç–µ
- Race condition –≤ connection pool
- –ò—Å—Ç–µ–∫–∞—é—â–∏–µ —Ç–æ–∫–µ–Ω—ã
- Zombie connections –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤

---

## ‚úÖ –†–ï–®–ï–ù–ò–Ø:

–í—Å–µ 5 –ø—Ä–æ–±–ª–µ–º –±—É–¥—É—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Ñ–∞–π–ª–∞—Ö:
1. `src/lib/prisma.ts` - –¥–æ–±–∞–≤–∏—Ç—å connection pool –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
2. `src/lib/auth.ts` - –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
3. `src/middleware.ts` - –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞
4. `src/lib/env.ts` - –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ DATABASE_URL —Å pool
5. `src/app/api/auth/login/route.ts` - —É–≤–µ–ª–∏—á–∏—Ç—å –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞

---

_–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: 10 –æ–∫—Ç—è–±—Ä—è 2025_

