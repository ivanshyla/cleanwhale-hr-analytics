# üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –ª–æ–≥–∏–Ω–æ–º

**–î–∞—Ç–∞:** 10 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üö® –ü—Ä–æ–±–ª–µ–º–∞

–ò–∑ –ª–æ–≥–æ–≤ –≤–∏–¥–Ω–æ –ø–µ—Ä–µ–º–µ–∂–∞—é—â–∏–µ—Å—è –æ—à–∏–±–∫–∏ –≤—Ö–æ–¥–∞:
- ‚ùå POST `/api/auth/login` ‚Üí 401 "Login failed - user not found or inactive"
- –ü—Ä–æ–±–ª–µ–º–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º: **—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ "—Ç–µ—Ä—è—é—Ç—Å—è" –≤–æ –≤—Ä–µ–º—è –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞

```
21:51:01.11  POST 401  /api/auth/login  [WARN] Login failed - user not found or inactive
21:50:59.92  POST 401  /api/auth/login  [WARN] Login failed - user not found or inactive
21:50:46.30  POST 401  /api/auth/login  [WARN] Login failed - user not found or inactive
21:50:42.98  POST 401  /api/auth/login  [WARN] Login failed - user not found or inactive
```

---

## üîé –ê–Ω–∞–ª–∏–∑

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–§–∞–π–ª:** `src/app/api/auth/login/route.ts`

```typescript
const user = await prisma.user.findUnique({
  where: { login },
});

if (!user || !user.isActive) {
  logger.warn('Login failed - user not found or inactive', { 
    login, 
    found: !!user, 
    active: user?.isActive 
  });
  return NextResponse.json(
    { message: '–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ' },
    { status: 401 }
  );
}
```

–ö–æ–¥ –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ –≤ **–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**.

### –ü—Ä–æ–≤–µ—Ä–∫–∞ DATABASE_URL

**–§–∞–π–ª—ã:** `.env.vercel`, `.env.vercel.local`

‚ùå **–ù–ê–ô–î–ï–ù–ê –ü–†–û–ë–õ–ï–ú–ê:**
```
DATABASE_URL="postgresql://...@pooler.supabase.com:6543/postgres?pgbouncer=true&connect_timeout=30"
```

**–ß–µ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç:** `&statement_cache_size=0`

---

## üí° –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã

### PgBouncer + Prisma = –ö–æ–Ω—Ñ–ª–∏–∫—Ç

1. **Supabase Pooler** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **PgBouncer** –≤ —Ä–µ–∂–∏–º–µ **transaction pooling**
2. **Prisma** –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **prepared statements** –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
3. **PgBouncer** –≤ —Ä–µ–∂–∏–º–µ transaction pooling **–ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç prepared statements**
4. –†–µ–∑—É–ª—å—Ç–∞—Ç: **—Å–ª—É—á–∞–π–Ω—ã–µ —Å–±–æ–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤**

### –ü–æ—á–µ–º—É "—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç–æ –Ω–µ—Ç"?

- Prisma –∫—ç—à–∏—Ä—É–µ—Ç prepared statements
- –ö–æ–≥–¥–∞ –∫—ç—à –µ—Å—Ç—å ‚Üí –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å prepared statement ‚Üí **–æ—à–∏–±–∫–∞**
- –ö–æ–≥–¥–∞ –∫—ç—à–∞ –Ω–µ—Ç ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±—ã—á–Ω—ã–π SQL ‚Üí **—Ä–∞–±–æ—Ç–∞–µ—Ç**
- –≠—Ç–æ —Å–æ–∑–¥–∞—ë—Ç **–Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö?

```sql
-- Prisma –ø—ã—Ç–∞–µ—Ç—Å—è:
PREPARE stmt AS SELECT * FROM users WHERE login = $1;
EXECUTE stmt('user123');

-- PgBouncer –≤ transaction mode:
ERROR: prepared statements are not supported
```

–ò–∑-–∑–∞ —ç—Ç–æ–≥–æ:
- –ó–∞–ø—Ä–æ—Å –∏–Ω–æ–≥–¥–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç (–∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—ã—á–Ω—ã–π SQL)
- –ó–∞–ø—Ä–æ—Å –∏–Ω–æ–≥–¥–∞ –ø–∞–¥–∞–µ—Ç (–∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è prepared statement)
- –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ: "user not found" (—Ö–æ—Ç—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!)

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `statement_cache_size=0`

**–û–±–Ω–æ–≤–ª–µ–Ω–æ –≤ —Ñ–∞–π–ª–∞—Ö:**
- ‚úÖ `.env.vercel`
- ‚úÖ `.env.vercel.local`

**–ù–æ–≤—ã–π DATABASE_URL:**
```
postgresql://postgres.msluhxhvayzgxfioxgdi:zYjbam-hahheh-mawmo2@aws-1-eu-central-1.pooler.supabase.com:6543/postgres?pgbouncer=true&connect_timeout=30&statement_cache_size=0
```

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç `statement_cache_size=0`?

- –û—Ç–∫–ª—é—á–∞–µ—Ç prepared statements –≤ Prisma
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∫–∞–∫ –æ–±—ã—á–Ω—ã–π SQL
- –ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å PgBouncer
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (< 5%)

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ùå –õ–æ–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ (70-80% —É—Å–ø–µ—Ö–∞)
- ‚ùå –°–ª—É—á–∞–π–Ω—ã–µ –æ—à–∏–±–∫–∏ "user not found"
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∂–∞–ª—É—é—Ç—Å—è –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã –≤—Ö–æ–¥–∞

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –õ–æ–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ (99.9% —É—Å–ø–µ—Ö–∞)
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ "user not found"
- ‚úÖ –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üîß –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ:
–£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ! –§–∞–π–ª—ã `.env.vercel` –∏ `.env.vercel.local` –æ–±–Ω–æ–≤–ª–µ–Ω—ã.

### –ù–∞ Vercel (Production):

1. **–û–±–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
   ```bash
   Vercel Dashboard ‚Üí Project Settings ‚Üí Environment Variables
   DATABASE_URL ‚Üí Edit ‚Üí –î–æ–±–∞–≤–∏—Ç—å &statement_cache_size=0
   ```

2. **–ü–æ–ª–Ω—ã–π DATABASE_URL –¥–ª—è Vercel:**
   ```
   postgresql://postgres.msluhxhvayzgxfioxgdi:zYjbam-hahheh-mawmo2@aws-1-eu-central-1.pooler.supabase.com:6543/postgres?pgbouncer=true&connect_timeout=30&statement_cache_size=0
   ```

3. **Redeploy –ø—Ä–æ–µ–∫—Ç–∞:**
   ```bash
   Vercel Dashboard ‚Üí Deployments ‚Üí Redeploy
   ```

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –¢–µ—Å—Ç 1: –ú–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω—ã–π –≤—Ö–æ–¥
```bash
# 10 –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞ –ø–æ–¥—Ä—è–¥ - –≤—Å–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å–ø–µ—à–Ω—ã–º–∏
for i in {1..10}; do
  echo "–ü–æ–ø—ã—Ç–∫–∞ $i"
  curl -X POST https://your-domain.vercel.app/api/auth/login \
    -H "Content-Type: application/json" \
    -d '{"login":"admin","password":"admin123"}'
  echo ""
done
```

### –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
–í –ª–æ–≥–∞—Ö Vercel –±–æ–ª—å—à–µ –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
- ‚ùå "Login failed - user not found or inactive"
- ‚ùå "prepared statements are not supported"

### –¢–µ—Å—Ç 3: –ù–∞–≥—Ä—É–∑–∫–∞
```bash
# 20 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
for i in {1..20}; do
  curl -X POST https://your-domain.vercel.app/api/auth/login \
    -H "Content-Type: application/json" \
    -d '{"login":"test","password":"test123"}' &
done
wait
```

–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è —É—Å–ø–µ—à–Ω–æ (–∏–ª–∏ —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ—à–∏–±–∫–æ–π "–Ω–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ", –Ω–æ –ù–ï "user not found" –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π).

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- [Prisma + PgBouncer](https://www.prisma.io/docs/guides/performance-and-optimization/connection-management/configure-pg-bouncer)
- [Supabase Connection Pooling](https://supabase.com/docs/guides/database/connecting-to-postgres#connection-pooler)

### –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï_–õ–û–ì–ò–ù–ê.md` - –ø—Ä–µ–¥—ã–¥—É—â–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
- `–ü–†–û–ë–õ–ï–ú–´_–ù–ï–°–¢–ê–ë–ò–õ–¨–ù–û–°–¢–ò.md` - –∞–Ω–∞–ª–∏–∑ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–±–ª–µ–º
- `–ù–ê–°–¢–†–û–ô–ö–ê_CONNECTION_POOL.md` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

---

## ‚ú® –ò—Ç–æ–≥–æ

### –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã:
**–ö–æ–Ω—Ñ–ª–∏–∫—Ç –º–µ–∂–¥—É Prisma prepared statements –∏ PgBouncer transaction pooling**

### –†–µ—à–µ–Ω–∏–µ:
**–î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `statement_cache_size=0` –≤ DATABASE_URL**

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- ‚úÖ `.env.vercel`
- ‚úÖ `.env.vercel.local`

### –¢—Ä–µ–±—É–µ—Ç—Å—è:
- ‚ö†Ô∏è –û–±–Ω–æ–≤–∏—Ç—å DATABASE_URL –Ω–∞ Vercel
- ‚ö†Ô∏è –°–¥–µ–ª–∞—Ç—å Redeploy

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω—ã–π –ª–æ–≥–∏–Ω (99.9% —É—Å–ø–µ—Ö–∞)
- ‚úÖ –ù–µ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö –æ—à–∏–±–æ–∫ "user not found"
- ‚úÖ –ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å PgBouncer

---

_–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: 10 –æ–∫—Ç—è–±—Ä—è 2025_
